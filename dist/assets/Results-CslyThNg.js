import{j as e,a as T,b as H,r as j,c as P,Q as L,L as S,B as y}from"./index-Ck4Mj6hj.js";import{C as g,a as h,b as N,c as w}from"./Card-SKlqbuTj.js";function M({title:s,bars:a,max:l=100}){const n=Math.max(...a.map(t=>Math.abs(t.value))),c=n>0?Math.max(n,l*.1):l;return e.jsxs("div",{children:[s&&e.jsx("h3",{className:"mb-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:s}),e.jsx("div",{className:"space-y-3",children:a.map((t,i)=>{const o=Math.min(100,Math.max(2,Math.round(Math.abs(t.value)/c*100))),d=t.value>=0;return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-700 dark:text-gray-300 font-medium flex-1 pr-2",children:t.label.replace(/^\d+\.\s*/,"")}),e.jsxs("span",{className:`font-bold tabular-nums ${d?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:[d?"+":"",t.value.toFixed(2)]})]}),e.jsx("div",{className:"h-4 w-full rounded-full bg-gray-100 dark:bg-gray-800 overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full transition-all duration-500 ease-out",style:{width:`${o}%`,backgroundColor:t.color||(d?"#16a34a":"#dc2626"),boxShadow:"inset 0 1px 2px rgba(0,0,0,0.1)"},role:"img","aria-label":`${t.label}: ${t.value.toFixed(2)}`,children:e.jsx("div",{className:"h-full w-full bg-gradient-to-r from-transparent to-white/20"})})})]},`${t.label}-${i}`)})}),a.length===0&&e.jsxs("div",{className:"text-center text-gray-500 dark:text-gray-400 py-8",children:[e.jsx("div",{className:"text-2xl mb-2",children:"📊"}),e.jsx("p",{className:"text-sm",children:"データがありません"})]})]})}const k=new TextEncoder,A=()=>"dev-insecure-secret",F=async s=>crypto.subtle.importKey("raw",k.encode(s),{name:"HMAC",hash:"SHA-256"},!1,["sign","verify"]),C={encode:s=>btoa(String.fromCharCode(...s)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,""),decode:s=>Uint8Array.from(atob(s.replace(/-/g,"+").replace(/_/g,"/")),a=>a.charCodeAt(0))},U=s=>{const a=s.map(l=>[l.questionId,l.value]);return JSON.stringify(a)},V=s=>JSON.parse(s).map(([l,n])=>({questionId:l,value:n})),D=async(s,a)=>{const l=Date.now().toString(),n=`${U(a)}|${l}`,c=await F(A()),t=await crypto.subtle.sign("HMAC",c,k.encode(n)),i=C.encode(new Uint8Array(t)),o=C.encode(k.encode(U(a))),d=new URL(s);return d.searchParams.set("data",o),d.searchParams.set("ts",l),d.searchParams.set("sig",i),d.toString()},J=async(s,a,l)=>{try{if(!s||!a||!l)return{valid:!1,error:"パラメータが不足しています。"};const n=1e3*60*60*24,c=Date.now(),t=Number(a);if(!Number.isFinite(t))return{valid:!1,error:"タイムスタンプが不正です。"};if(c-t>n)return{valid:!1,error:"共有URLの有効期限が切れています。"};const i=new TextDecoder().decode(C.decode(s)),o=V(i),d=`${i}|${a}`,f=await F(A());return await crypto.subtle.verify("HMAC",f,C.decode(l),k.encode(d))?{valid:!0,answers:o}:{valid:!1,error:"署名の検証に失敗しました。"}}catch{return{valid:!1,error:"共有URLの解析に失敗しました。"}}};function K(){const{state:s,loadAnswers:a,reset:l}=T(),n=H(),c=new URLSearchParams(n.search),[t,i]=j.useState(null),[o,d]=j.useState(null),[f,$]=j.useState(!1);j.useEffect(()=>{const r=c.get("data"),x=c.get("ts"),b=c.get("sig");r&&x&&b&&J(r,x,b).then(v=>{v.valid&&v.answers?(a(v.answers),$(!0)):i(v.error||"共有URLの検証に失敗しました。")})},[]);const u=s.answers.some(r=>r.value===0),m=j.useMemo(()=>P(s.answers),[s.answers]),I=L.filter(r=>r.weight>0).map(r=>{var x;return{label:`${r.id}. ${r.text}`,value:(((x=s.answers.find(b=>b.questionId===r.id))==null?void 0:x.value)||0)*r.weight,color:"#16a34a"}}),R=L.filter(r=>r.weight<0).map(r=>{var x;return{label:`${r.id}. ${r.text}`,value:Math.abs((((x=s.answers.find(b=>b.questionId===r.id))==null?void 0:x.value)||0)*r.weight),color:"#dc2626"}}),E=async()=>{try{const r=await D(window.location.origin+"/results",s.answers);d(r)}catch{i("共有リンクの生成に失敗しました。")}},p=(r=>{switch(r){case"very-good":return{emoji:"🌟",color:"text-green-600 dark:text-green-400",bgColor:"bg-green-50 dark:bg-green-900/30",borderColor:"border-green-200 dark:border-green-800"};case"good":return{emoji:"😊",color:"text-blue-600 dark:text-blue-400",bgColor:"bg-blue-50 dark:bg-blue-900/30",borderColor:"border-blue-200 dark:border-blue-800"};case"neutral":return{emoji:"😐",color:"text-yellow-600 dark:text-yellow-400",bgColor:"bg-yellow-50 dark:bg-yellow-900/30",borderColor:"border-yellow-200 dark:border-yellow-800"};case"low":return{emoji:"😔",color:"text-orange-600 dark:text-orange-400",bgColor:"bg-orange-50 dark:bg-orange-900/30",borderColor:"border-orange-200 dark:border-orange-800"};case"needs-improvement":return{emoji:"😰",color:"text-red-600 dark:text-red-400",bgColor:"bg-red-50 dark:bg-red-900/30",borderColor:"border-red-200 dark:border-red-800"};default:return{emoji:"📊",color:"text-gray-600 dark:text-gray-400",bgColor:"bg-gray-50 dark:bg-gray-900/30",borderColor:"border-gray-200 dark:border-gray-800"}}})(m.scoreLevel);return e.jsx("main",{className:"container py-8",children:e.jsxs("div",{className:"mx-auto max-w-4xl",children:[e.jsxs("header",{className:"mb-8 text-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-gray-100",children:"診断結果"}),t&&e.jsx("div",{className:"mt-4 p-4 rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",role:"alert",children:t})})]}),u&&!f?e.jsx("section",{className:"mb-8",children:e.jsxs("div",{className:"rounded-lg border border-yellow-300 bg-yellow-50 p-6 text-yellow-800 dark:border-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-200 text-center",children:[e.jsx("div",{className:"text-2xl mb-2",children:"⚠️"}),e.jsx("h2",{className:"font-semibold mb-2",children:"未回答の質問があります"}),e.jsx("p",{className:"text-sm mb-4",children:"診断に戻って全ての質問に回答してください。"}),e.jsx(S,{to:"/diagnostic",children:e.jsx(y,{variant:"secondary",children:"診断に戻る"})})]})}):e.jsx(e.Fragment,{children:e.jsxs("section",{className:"mb-8",children:[e.jsxs("div",{className:`rounded-lg border p-6 text-center mb-6 ${p.bgColor} ${p.borderColor}`,children:[e.jsx("div",{className:"text-4xl mb-2",children:p.emoji}),e.jsxs("div",{className:`text-2xl font-bold mb-2 ${p.color}`,children:["ToMo指数: ",m.totalScore.toFixed(2)]}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:m.commentary})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-3",children:[e.jsx(g,{className:"text-center hover:shadow-md transition-shadow",children:e.jsxs(h,{className:"pt-6",children:[e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:"総合スコア"}),e.jsx("div",{className:"text-3xl font-bold text-gray-900 dark:text-gray-100",children:m.totalScore.toFixed(2)}),e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"-100 〜 +100"})]})}),e.jsx(g,{className:"text-center hover:shadow-md transition-shadow",children:e.jsxs(h,{className:"pt-6",children:[e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:"ポジティブ要因"}),e.jsxs("div",{className:"text-3xl font-bold text-green-600 dark:text-green-400",children:["+",m.positiveScore.toFixed(2)]}),e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"内発的動機づけ"})]})}),e.jsx(g,{className:"text-center hover:shadow-md transition-shadow",children:e.jsxs(h,{className:"pt-6",children:[e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:"ネガティブ要因"}),e.jsxs("div",{className:"text-3xl font-bold text-red-600 dark:text-red-400",children:["-",m.negativeScore.toFixed(2)]}),e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"外発的動機づけ"})]})})]})]})}),!u&&e.jsxs("section",{className:"mb-8 grid gap-6 md:grid-cols-2",children:[e.jsxs(g,{children:[e.jsx(N,{children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-green-600 dark:text-green-400",children:"📈"}),"ポジティブ要因の寄与"]})}),e.jsx(h,{children:e.jsx(M,{bars:I,max:100})})]}),e.jsxs(g,{children:[e.jsx(N,{children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-red-600 dark:text-red-400",children:"📉"}),"ネガティブ要因の寄与"]})}),e.jsx(h,{children:e.jsx(M,{bars:R,max:100})})]})]}),!u&&e.jsxs(g,{className:"mb-8",children:[e.jsx(N,{children:e.jsx(w,{children:"各質問の詳細分析"})}),e.jsx(h,{children:e.jsx("div",{className:"space-y-4",children:m.questionContributions.map(r=>e.jsx("div",{className:"p-4 rounded-lg border border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 text-sm font-semibold",children:r.questionId}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full font-medium ${r.weight>0?"bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300":"bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300"}`,children:r.weight>0?"ポジティブ":"ネガティブ"})]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300 mb-2",children:r.questionText}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["回答値: ",r.rawValue," × 重み: ",r.weight," = 寄与度: ",r.weightedValue.toFixed(2)]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:`text-xl font-bold ${r.weightedValue>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:[r.weightedValue>=0?"+":"",r.weightedValue.toFixed(2)]})})]})},r.questionId))})})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[!f&&!u&&e.jsxs(y,{onClick:E,className:"flex items-center gap-2",children:[e.jsx("span",{children:"🔗"}),"結果を共有"]}),e.jsx(S,{to:"/diagnostic",children:e.jsxs(y,{variant:"secondary",onClick:()=>l(),className:"flex items-center gap-2",children:[e.jsx("span",{children:"🔄"}),"再診断"]})}),e.jsx(S,{to:"/",children:e.jsxs(y,{variant:"ghost",className:"flex items-center gap-2",children:[e.jsx("span",{children:"🏠"}),"ホームに戻る"]})})]}),o&&!u&&e.jsxs(g,{className:"mt-8",children:[e.jsx(N,{children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx("span",{children:"🔗"}),"共有用URL"]})}),e.jsx(h,{children:e.jsxs("div",{className:"p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg border border-blue-200 dark:border-blue-800",children:[e.jsx("p",{className:"break-words text-blue-700 dark:text-blue-400 font-mono text-sm mb-3",children:e.jsx("a",{href:o,className:"hover:underline",children:o})}),e.jsx("div",{className:"flex gap-2",children:e.jsx(y,{variant:"secondary",onClick:()=>navigator.clipboard.writeText(o),className:"text-xs",children:"URLをコピー"})}),e.jsx("p",{className:"mt-3 text-xs text-gray-600 dark:text-gray-400",children:"⚠️ 注意: クライアントサイド実装のため完全な改ざん防止ではありません。"})]})})]})]})})}export{K as default};
