import{j as e,a as _,b as B,r as b,c as J,Q as M,L as A,B as p,g as O}from"./index-DUnTtpZu.js";import{C as N,a as w,b as k,c as y}from"./Card-Csz7sTIT.js";function R({title:t,bars:l,max:d=100}){const i=Math.max(...l.map(a=>Math.abs(a.value))),m=i>0?Math.max(i,d*.1):d;return e.jsxs("div",{children:[t&&e.jsx("h3",{className:"mb-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:t}),e.jsx("div",{className:"space-y-3",children:l.map((a,h)=>{const o=Math.min(100,Math.max(2,Math.round(Math.abs(a.value)/m*100))),c=a.value>=0;return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-700 dark:text-gray-300 font-medium flex-1 pr-2",children:a.label.replace(/^\d+\.\s*/,"")}),e.jsxs("span",{className:`font-bold tabular-nums ${c?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:[c?"+":"",a.value.toFixed(2)]})]}),e.jsx("div",{className:"h-4 w-full rounded-full bg-gray-100 dark:bg-gray-800 overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full transition-all duration-500 ease-out",style:{width:`${o}%`,backgroundColor:a.color||(c?"#16a34a":"#dc2626"),boxShadow:"inset 0 1px 2px rgba(0,0,0,0.1)"},role:"img","aria-label":`${a.label}: ${a.value.toFixed(2)}`,children:e.jsx("div",{className:"h-full w-full bg-gradient-to-r from-transparent to-white/20"})})})]},`${a.label}-${h}`)})}),l.length===0&&e.jsxs("div",{className:"text-center text-gray-500 dark:text-gray-400 py-8",children:[e.jsx("div",{className:"text-2xl mb-2",children:"📊"}),e.jsx("p",{className:"text-sm",children:"データがありません"})]})]})}const S=new TextEncoder,E=()=>"tomo-index-share-secret-2024",I=async t=>crypto.subtle.importKey("raw",S.encode(t),{name:"HMAC",hash:"SHA-256"},!1,["sign","verify"]),C={encode:t=>btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,""),decode:t=>Uint8Array.from(atob(t.replace(/-/g,"+").replace(/_/g,"/")),l=>l.charCodeAt(0))},T=t=>{const l=t.map(d=>[d.questionId,d.value]);return JSON.stringify(l)},K=t=>JSON.parse(t).map(([d,i])=>({questionId:d,value:i})),Q=async(t,l)=>{const d=Date.now().toString(),i=`${T(l)}|${d}`,m=await I(E()),a=await crypto.subtle.sign("HMAC",m,S.encode(i)),h=C.encode(new Uint8Array(a)),o=C.encode(S.encode(T(l))),c=new URL(t);return c.searchParams.set("data",o),c.searchParams.set("ts",d),c.searchParams.set("sig",h),c.toString()},V=async(t,l,d)=>{try{if(!t||!l||!d)return{valid:!1,error:"パラメータが不足しています。"};const i=1e3*60*60*24,m=Date.now(),a=Number(l);if(!Number.isFinite(a))return{valid:!1,error:"タイムスタンプが不正です。"};if(m-a>i)return{valid:!1,error:"共有URLの有効期限が切れています。"};const h=new TextDecoder().decode(C.decode(t)),o=K(h),c=`${h}|${l}`,v=await I(E());return await crypto.subtle.verify("HMAC",v,C.decode(d),S.encode(c))?{valid:!0,answers:o}:{valid:!1,error:"署名の検証に失敗しました。"}}catch{return{valid:!1,error:"共有URLの解析に失敗しました。"}}};function W(){const{state:t,loadAnswers:l,reset:d}=_(),i=B(),m=new URLSearchParams(i.search),[a,h]=b.useState(null),[o,c]=b.useState(null),[v,U]=b.useState(!1);b.useEffect(()=>{const s=m.get("data"),r=m.get("ts"),x=m.get("sig");s&&r&&x&&V(s,r,x).then(n=>{n.valid&&n.answers?(l(n.answers),U(!0)):h(n.error||"共有URLの検証に失敗しました。")})},[]);const j=t.answers.some(s=>s.value===0),u=b.useMemo(()=>J(t.answers),[t.answers]),[g,F]=b.useState({count:0,average:0,median:0,min:0,max:0,totalCount:0}),[L,$]=b.useState("loading");b.useEffect(()=>{(async()=>{try{$("loading");const r=await O(30);F(r),$("server")}catch(r){console.error("Failed to load statistics from server:",r),$("error"),F({count:0,average:0,median:0,min:0,max:0,totalCount:0})}})()},[]);const H=M.filter(s=>s.weight>0).map(s=>{var r;return{label:`${s.id}. ${s.text}`,value:(((r=t.answers.find(x=>x.questionId===s.id))==null?void 0:r.value)||0)*s.weight,color:"#16a34a"}}),P=M.filter(s=>s.weight<0).map(s=>{var r;return{label:`${s.id}. ${s.text}`,value:Math.abs((((r=t.answers.find(x=>x.questionId===s.id))==null?void 0:r.value)||0)*s.weight),color:"#dc2626"}}),D=async()=>{try{const s=await Q(window.location.origin+"/results",t.answers);c(s)}catch{h("共有リンクの生成に失敗しました。")}};return e.jsx("main",{className:"container py-8",children:e.jsxs("div",{className:"mx-auto max-w-4xl",children:[e.jsxs("header",{className:"mb-8 text-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-gray-100",children:"診断結果"}),a&&e.jsx("div",{className:"mt-4 p-4 rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",role:"alert",children:a})})]}),j&&!v?e.jsx("section",{className:"mb-8",children:e.jsxs("div",{className:"rounded-lg border border-yellow-300 bg-yellow-50 p-6 text-yellow-800 dark:border-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-200 text-center",children:[e.jsx("div",{className:"text-2xl mb-2",children:"⚠️"}),e.jsx("h2",{className:"font-semibold mb-2",children:"未回答の質問があります"}),e.jsx("p",{className:"text-sm mb-4",children:"診断に戻って全ての質問に回答してください。"}),e.jsx(A,{to:"/diagnostic",children:e.jsx(p,{variant:"secondary",children:"診断に戻る"})})]})}):e.jsx(e.Fragment,{children:e.jsxs("section",{className:"mb-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"text-lg text-gray-700 dark:text-gray-300 mb-4",children:"あなたのToMo指数は..."}),e.jsxs("div",{className:"text-6xl font-bold text-orange-500 mb-2",children:[u.totalScore.toFixed(2),e.jsx("span",{className:"text-3xl",children:"点"}),"です"]}),e.jsx("div",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"点数は-100点から+100点の範囲となります。"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:u.commentary})]}),L==="error"&&e.jsx("div",{className:"mb-8 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:"⚠️ サーバーに接続できないため、統計データを表示できません。"})}),L==="server"&&g.count>0&&e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"relative overflow-hidden rounded-xl bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 dark:from-slate-900 dark:via-blue-900/50 dark:to-indigo-900/50 p-6 shadow-sm border border-slate-200/50 dark:border-slate-700/50",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-400/10 to-indigo-400/10 rounded-full -translate-y-16 translate-x-16"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-purple-400/10 to-pink-400/10 rounded-full translate-y-12 -translate-x-12"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"flex items-center justify-center mb-6",children:e.jsx("div",{className:"bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-full px-4 py-2 shadow-sm",children:e.jsxs("span",{className:"text-sm font-medium text-slate-600 dark:text-slate-300",children:["📊 診断統計データ（直近30件）",e.jsx("span",{className:"ml-2 text-xs text-green-600 dark:text-green-400",children:"● サーバーデータ"})]})})}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-4",children:[e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-slate-700 dark:text-slate-200 mb-1",children:u.totalScore.toFixed(2)}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 font-medium",children:"あなたのスコア"})]})}),e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-600 dark:text-emerald-400 mb-1",children:g.average}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 font-medium",children:"直近30件の平均"})]})}),e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-violet-600 dark:text-violet-400 mb-1",children:g.median}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 font-medium",children:"直近30件の中央値"})]})}),e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-sky-600 dark:text-sky-400 mb-1",children:g.count}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 font-medium",children:"総回答者数"})]})})]}),e.jsxs("div",{className:"mt-6 text-center space-y-3",children:[e.jsx("div",{className:"inline-flex items-center bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm rounded-full px-6 py-3 shadow-sm",children:e.jsxs("span",{className:"text-sm text-slate-600 dark:text-slate-300",children:["あなたは平均より",u.totalScore>g.average?e.jsxs("span",{className:"ml-1 inline-flex items-center text-emerald-600 dark:text-emerald-400 font-semibold",children:[e.jsx("span",{className:"mr-1",children:"📈"}),(u.totalScore-g.average).toFixed(1),"点高い"]}):u.totalScore===g.average?e.jsxs("span",{className:"ml-1 inline-flex items-center text-slate-600 dark:text-slate-400 font-semibold",children:[e.jsx("span",{className:"mr-1",children:"⚖️"}),"同じ"]}):e.jsxs("span",{className:"ml-1 inline-flex items-center text-amber-600 dark:text-amber-400 font-semibold",children:[e.jsx("span",{className:"mr-1",children:"📉"}),(g.average-u.totalScore).toFixed(1),"点低い"]})]})}),e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400 space-y-1",children:[e.jsx("div",{children:"※ 統計は直近30件の回答データから計算"}),e.jsx("div",{children:"※ 全て未回答（0点）の人は統計から除外"}),e.jsx("div",{children:"※ データベースには最大1000件まで保存"})]})]})]})]})})]})}),!j&&e.jsxs("section",{className:"mb-8 grid gap-6 md:grid-cols-2",children:[e.jsxs(N,{children:[e.jsx(w,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-green-600 dark:text-green-400",children:"📈"}),"ポジティブ要因の寄与"]})}),e.jsx(y,{children:e.jsx(R,{bars:H,max:100})})]}),e.jsxs(N,{children:[e.jsx(w,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-red-600 dark:text-red-400",children:"📉"}),"ネガティブ要因の寄与"]})}),e.jsx(y,{children:e.jsx(R,{bars:P,max:100})})]})]}),!j&&e.jsxs(N,{className:"mb-8",children:[e.jsx(w,{children:e.jsx(k,{className:"text-center text-xl",children:"あなたの回答"})}),e.jsxs(y,{children:[e.jsx("div",{className:"space-y-8",children:M.map(s=>{const r=t.answers.find(n=>n.questionId===s.id),x=(r==null?void 0:r.value)||0;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("span",{className:"text-slate-600 dark:text-slate-400 font-medium text-lg mt-1",children:[s.id,"."]}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-slate-700 dark:text-slate-300 leading-relaxed",children:s.text.split("は").map((n,f)=>f===1?e.jsxs("span",{className:"text-orange-500 font-medium",children:["は",n]},f):n+(f===0?"は":""))})})]}),e.jsxs("div",{className:"ml-8",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500 dark:text-slate-400 mb-3 font-medium",children:[e.jsx("span",{children:"全く違う"}),e.jsx("span",{children:"全くそのとおりである"})]}),e.jsx("div",{className:"flex items-center justify-between gap-2",children:Array.from({length:7},(n,f)=>f+1).map(n=>e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all duration-200 ${x===n?"bg-blue-500 border-blue-500 shadow-lg ring-4 ring-blue-200 dark:ring-blue-800":"border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 hover:border-blue-400"}`,children:x===n&&e.jsx("div",{className:"w-3 h-3 rounded-full bg-white"})}),e.jsx("span",{className:`text-sm font-medium transition-colors ${x===n?"text-blue-600 dark:text-blue-400":"text-slate-400 dark:text-slate-500"}`,children:n})]},n))})]})]},s.id)})}),e.jsx("div",{className:"mt-8 p-4 bg-slate-100/70 dark:bg-slate-700/50 rounded-lg border border-slate-200/50 dark:border-slate-600/50",children:e.jsx("div",{className:"text-center text-sm text-slate-600 dark:text-slate-400",children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{children:"📝"}),"回答スケール: 1 (全く違う) 〜 7 (全くそのとおりである)"]})})})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[!v&&!j&&e.jsxs(p,{onClick:D,className:"flex items-center gap-2",children:[e.jsx("span",{children:"🔗"}),"結果を共有"]}),e.jsx(A,{to:"/diagnostic",children:e.jsxs(p,{variant:"secondary",onClick:()=>d(),className:"flex items-center gap-2",children:[e.jsx("span",{children:"🔄"}),"再診断"]})}),e.jsx(A,{to:"/",children:e.jsxs(p,{variant:"ghost",className:"flex items-center gap-2",children:[e.jsx("span",{children:"🏠"}),"ホームに戻る"]})})]}),!j&&e.jsxs("div",{className:"text-center mt-8",children:[e.jsx("div",{className:"mb-4 text-gray-700 dark:text-gray-300 font-medium",children:"結果をシェアする"}),e.jsx("button",{onClick:()=>{const r=`https://twitter.com/intent/tweet?text=${`あなたのToMo指数は${u.totalScore.toFixed(2)}点です。点数は-100点から+100点の範囲となります。%0A%0A#ToMo指数診断`}&url=${encodeURIComponent(window.location.href)}`;window.open(r,"_blank","noopener,noreferrer")},className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-full transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-110","aria-label":"Twitterでシェア",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"})})})]}),o&&!j&&e.jsxs(N,{className:"mt-8",children:[e.jsx(w,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx("span",{children:"🔗"}),"共有用URL"]})}),e.jsx(y,{children:e.jsxs("div",{className:"p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg border border-blue-200 dark:border-blue-800",children:[e.jsx("p",{className:"break-words text-blue-700 dark:text-blue-400 font-mono text-sm mb-3",children:e.jsx("a",{href:o,className:"hover:underline",children:o})}),e.jsx("div",{className:"flex gap-2",children:e.jsx(p,{variant:"secondary",onClick:()=>navigator.clipboard.writeText(o),className:"text-xs",children:"URLをコピー"})}),e.jsx("p",{className:"mt-3 text-xs text-gray-600 dark:text-gray-400",children:"⚠️ 注意: クライアントサイド実装のため完全な改ざん防止ではありません。"})]})})]})]})})}export{W as default};
